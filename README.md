GTP-U User Plane Function (UPF) based on VPP
============================================

UPF implements a GTP-U user plane based on [3GPP TS 23.214][TS23214]
and [3GPP TS 29.244][TS29244] Release 15. It is implemented as a plugin
for [FD.io VPP][VPP].


Current State
-------------

This UPF implementation is used in production in conjunction with [erGW][erGW] as
GGSN/PGW in multiple installation in several telecom operators (Tier 1 and smaller).

Working features
----------------

* PFCP protocol
  * en/decoding of most IEs
  * heartbeat
  * node related messages
  * session related messages
* Uplink and Downlink Packet Detection Rules (PDR) and
  Forward Action Rules (FAR) -- (some parts)
* IPv4 -- inner and outer
* IPv6 -- inner and outer
* Usage Reporting Rules (URR)
* PFCP Session Reports
* Linked Usage Reports

No yet working
--------------

* Buffer Action Rules (BAR)
* QoS Enforcement Rule (QER)

Limitations
-----------

* FAR action with destination LI are not implemented
* Ethernet bearer support

General limitations and known deficits
--------------------------------------

* Error handling in Sx procedures is weak

Development setup
-----------------

Design rationale for the development environment is this:

* provide an easily reproducible development and build environment
  usable both on CI and locally
* provide quick commands for common tasks
* simplify bisecting against upstream VPP
* discourage downstream VPP changes, as we should make effort to
  upstream them

Relevant parts of the source tree layout:
* `hack/` contains helper scripts most of which are wrapped in `make`
  commands
* `Makefile` provides user interface for the environment
* `upf/` contains UPF source code
* `upf/test/` contains UPF integration tests
* `vpp/` contains VPP source code and is not committed
* `vpp-patches/` contains patches to apply to the upstream VPP code
  (applied automatically via `git am`; generated by hand with `git
  format-patch`)
* `vpp.spec` contains the info on VPP repo, branch and commit to use

There's a simple dockerized environment wrapped in 'make'
commands. During the development cycle, VPP is cloned into `vpp/`
subdirectory from an upstream repository with some of the
[patches](vpp-patches/) applied. This is done automatically but can
also be done via `make update-vpp` which will delete all of the
changes made to `vpp/` directory. You can make temporary changes under
`vpp/` for debugging purposes.

The "build image" which is used for the devenv is tagged with a hash
of `Dockerfile.build` as well as VPP's external dependencies.

The following `make` commands are supported:

* `make image-debug` builds a debug UPF Docker image named `upf:debug`
* `make image-release` builds a release UPF Docker image named `upf:release`
* `make test-debug`, `make test-release` build VPP and run UPF
  integration tests in debug and release mode respectively. The
  compilation results are retained under `vpp/`
* `make retest-debug`, `make retest-release` run UPF integration tests
  in debug and release mode respectively without building VPP. These
  can be run under `make test-debug` / `make test-release` to re-run
  the tests quickly if there were no UPF / VPP code changes
* `make ensure-build-image` checks if the build image exists or can be
  pulled and builds it otherwise
* `make update-build-image-tag` updates the build image tag in
  `.gitlab-ci.yaml` and Dockerfiles according to the hash calculated
  from `Dockerfile.build` and VPP external dependencies
* `make install-hooks` installs git hooks in the repo which prevent
  the user from making commits that contain `ZZZZZ:` substring. This
  is handy for debug print like `clib_warning("ZZZZZ: i %d", i);`
* `make update-vpp` re-clones VPP into `vpp/` directory
* `make buildenv` runs an interactive shell inside the build
  environment with UPF and VPP sources mounted into the container

If docker is not used, one should set the following environment
variable to disable wrapping the internally run commands in a docker
container:

```
export UPF_NO_DOCKER_BUILDENV=1
```

As an alternative, it’s possible to run commands such as

```console
$ make -C vpp test TEST=test_upf V=2 EXTERN_TESTS=../../upf/test
```

using VPP’s usual Makefile. [upf/](upf/) subdirectory is symlinked to
`vpp/src/plugins/upf` (note though that there's an issue with VPP's
test discovery mechanism, thus `EXTERN_TEST=...` variable is required
to run the tests).

[VPP]: https://fd.io
[erGW]: https://github.com/travelping/ergw
[TS23214]: http://www.3gpp.org/ftp/Specs/html-info/23214.htm
[TS29244]: http://www.3gpp.org/ftp/Specs/html-info/29244.htm
